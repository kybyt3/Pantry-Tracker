<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Pantry Inventory Management</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <ul class="nav-list">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="pantry.html">Pantry</a></li>
            <li><a href="shopping-list.html">Shopping List</a></li>
            <li><a href="#" onclick="handleLogout()">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="text-center mt-2">
            <h1>Manage Users</h1>
            <p class="admin-only">Add, edit, or remove user accounts</p>
            <button class="btn btn-primary" onclick="showModal('addUserModal')">Add New User</button>
        </div>

        <div class="mt-2">
            <div class="form-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userList">
                    <!-- Users will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New User</h2>
            <form id="addUserForm" onsubmit="return handleAddUser(event)">
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="userPassword">Password</label>
                    <input type="password" id="userPassword" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="userRole">Role</label>
                    <select id="userRole" class="form-control" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Add User</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit User</h2>
            <form id="editUserForm" onsubmit="return handleEditUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserEmail">Email</label>
                    <input type="email" id="editUserEmail" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="editUserRole">Role</label>
                    <select id="editUserRole" class="form-control" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editUserStatus">Status</label>
                    <select id="editUserStatus" class="form-control" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Update User</button>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script type="module">
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { auth } from "./firebase-config.js";

        const db = getFirestore();

        // Check if user is admin
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            const userProfile = await getUserProfile(user.uid);
            if (!userProfile || userProfile.role !== 'admin') {
                window.location.href = 'dashboard.html';
                return;
            }

            // Fetch users from Firestore
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const users = [];
            usersSnapshot.forEach(doc => {
                users.push({ id: doc.id, ...doc.data() });
            });
            displayUsers(users);
        });

        // Display users
        function displayUsers(userList) {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = '';

            userList.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.email}</td>
                    <td>${user.role || 'user'}</td>
                    <td>${user.status || 'active'}</td>
                    <td>${formatDateTime(user.lastLogin)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editUser('${user.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Add new user
        function handleAddUser(event) {
            event.preventDefault();
            
            const newUser = {
                id: Date.now(),
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                status: 'active',
                lastLogin: new Date().toISOString()
            };

            users.push(newUser);
            displayUsers(users);
            hideModal('addUserModal');
            showAlert('User added successfully');
            
            return false;
        }

        // Edit user
        function editUser(id) {
            const user = users.find(user => user.id === id);
            if (user) {
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserStatus').value = user.status;
                showModal('editUserModal');
            }
        }

        function handleEditUser(event) {
            event.preventDefault();
            
            const id = parseInt(document.getElementById('editUserId').value);
            const userIndex = users.findIndex(user => user.id === id);
            
            if (userIndex !== -1) {
                users[userIndex] = {
                    ...users[userIndex],
                    email: document.getElementById('editUserEmail').value,
                    role: document.getElementById('editUserRole').value,
                    status: document.getElementById('editUserStatus').value
                };

                displayUsers(users);
                hideModal('editUserModal');
                showAlert('User updated successfully');
            }
            
            return false;
        }

        // Delete user
        function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(user => user.id !== id);
                displayUsers(users);
                showAlert('User deleted successfully');
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = users.filter(user => 
                user.email.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });
    </script>
</body>
</html> 